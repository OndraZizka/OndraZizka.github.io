<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>WebTTD – A Browser-based Transport Tycoon Derivate - Ondřej Žižka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="My personal web">
    <meta name="author" content="Ondřej Žižka">
    <meta name="generator" content="JBake">


    <link rel="stylesheet" href="../../../css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../css/asciidoctor.css">
    <link rel="stylesheet" href="../../../css/base.css">
    <link rel="stylesheet" href="../../../css/doc-body.css">
    <link rel="stylesheet" href="../../../css/prettify.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
</head>
<body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.zizka.ch/">Ondřej Žižka</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../../../index.html">Blog</a></li>
            <li><a href="../../../archive.html">Archive</a></li>
            <li><a href="../../../tags">Tags</a></li>

            <li><a href="../../../about.html">About Me</a></li>
            <li><a href="../../../feed.xml">RSS feed</a></li>
            <li><a href="../../../sitemap.xml">Sitemap</a></li>
            <!--
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li>
            -->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">

	<div class="page-header">
        <h1>WebTTD – A Browser-based Transport Tycoon Derivate - Ondřej Žižka</h1>
	</div>

	<div class="date"><em>2012-12-13</em></div>

	<div class="doc-body"><h3>WebTTD – A Browser-based Transport Tycoon Derivate</h3>

<p>I've a fixed idea of creating a web version of Transport Tycoon.</p>

<p>Imagine how wonderful it would be if you could build your company for several
weeks or months, on a vast landscape. No hush-hush game like classical TTD, but
rather slow progress, more business cooperation amongst players…</p>

<h4>Game concept</h4>

<p>Web game concepts are different from those of desktop games. If you ever have
played Travian, you know how such web game works.</p>

<p>1) First, the game progress must be <em>veeery sloooow</em>. Why? Because web
games are played occassionally – during a boring meetings, during launch
break, before bed… People want to spend few minutes daily on such game. What
can you do in that time? Build a track or two, buy a train and set their orders.
Then you leave it until the next day. The train should do no more than few turns
in that time.</p>

<p>2) Second, there are many many players, which join the game at different
times. By the time you have been playing for several weeks, someone other joins
the game; so you have your logistic imperium with dozens of tracks, and the
other player has nothing but a loan. I've been thinking about this a lot, and
came up with a solution similar to Travian's one.</p>

<p>3) Third, web games are not fun because of fancy graphics; But even not
because of complicated game logic. The best part of MMO games are – the other
players! Yes, it's the social part of the game which keeps people playing: The
feel of being a part of gang.</p>

<p>This aspect would have to be carefully applied in the game design. Again,
I have ideas about how to achieve that: In classical TTD, you always found
point A, point B and built a track between them. Sometimes you found out that
it's impossible because some area is being blocked by other player.</p>

<p>Well, in MMO-TTD, this would inevitably happen all the time, so it's not a
good concept at all. Better would be to let people deal at which price can one
player use other's track.</p>

<p>There are other things to think about, but these three are the main to
focus at.</p>

<h4>Technology</h4>

<p>It would be programmed using technologies:</p>

<p>* HTML + CSS, eventually Canvas<br />
* JavaScript for client logic<br />
* J2EE backend with JBoss Cache,<br />
* or perhaps thin PHP layer with stored procedures in PostgreSQL or MySQL</p>

<p>So far, I gave it about two days of work and have some poor
proofs-of-concept:</p>

<p>1) TTD-like dialogs made in HTML. Currently only layout + some DoJo code to
make them move.<br />
This part would need a lot of work: many dialog types + data binding.<br />
See <a href="/samostatne/ttd/HtmlGUI/TTDdialog.html">the demo</a> .<br />
(Note that the dialogs are not images, but only HTML+CSS – see the
page code.)</p>

<div><img src="/samostatne/ttd/HtmlGUI/screenshots/screenshot01.png"
alt="WebTTD – dialogs" /></div>

<p>2) Isometric landscape drawing and editing, plus client/server communication
(AJAX).<br />
I'll add URL of this drawing as soon as I put the database on the server.<br />
Works quite fine, but there's one big problem: When you click somewhere,<br />
it's almost impossible to compute which cell has been clicked, so it's needed
to store it somewhere.<br />
And since current technologies, including canvas, do not provide such
functionality,<br />
the only solution seems to use only flat landscape, which is kinda boring…</p>

<p>Or, the other option – create the client in .NET or Java or Flash.<br />
Since I don't like Flash and .NET is bound to Microsoft, it would be
Java's WebStart.</p>

<div><img src="/samostatne/ttd/landscape/screenshots/webttd-landscape-01.png"
alt="WebTTD – landscape" /><br />
<img src="/samostatne/ttd/landscape/screenshots/webttd-landscape-02.png"
alt="WebTTD – landscape" /></div>

<p>Next I'd move to drawing of vehicles. That should be quite easy, provided we
had waypoints of their movement together with their times.</p>

<p>These data have to be computed on the server side. So next stage would be
J2EE or PL/SQL programming <del>(I'm SQL fan, so it's likely to be PL/SQL
:)</del> //Decision changed:// Due to performance requirements, reading
everything to and from the DB is not a good idea. Let it be Java.</p>

<p>Then the data are needed to be send to the client somehow, so some AJAX-Push
would be necessary.</p>

<p>Of course the client will not load all the updates, only those which
currently affect him – that means:</p>

<ul>
	<li>Only cells in his viewport</li>

	<li>Only messages he configured to get</li>

	<li>Vehicles positions are only send when it departs onto a track</li>

	<li>No metrics of stations, towns, industries, companies – that's only
	on-demand in a dialog.</li>
</ul>

<p>Estimated data transfer amounts is hundreds of bytes per second,
at most.</p>

<h4>Current code structure</h4>

<h5>Client side</h5>

<ul>
	<li><code>Xcom</code> – the main class / namespace (yeah, originally it
	should have been UFO ;)
		<ul>
			<li><code>Xcom.Land</code> – the class which manages the map data.</li>

			<li><code>Xcom.data: {</code>
				<ul>
					<li><code>cities: []</code></li>

					<li><code>industries: []</code></li>

					<li><code>roadTracks: []</code></li>

					<li><code>roadVehicles: []</code></li>

					<li><code>companies: []</code></li>

					<li><code>stations: []</code></li>
				</ul>
			</li>

			<li><code>}</code></li>
		</ul>
	</li>

	<li><code>eMap</code> – manages the DHTML representation of the land.
		<ul>
			<li><code>eMap.TransformFieldXYtoCoords( x, y, level )</code> – computes
			mapbox coords of the given cell, taking the map offset into account.</li>

			<li><code>eMap.TransformCoordsToFieldXY( x, y )</code> – computes position of
			the cell on the given coordinates, taking the map offset into account.</li>

			<li><code>eMap.DrawArea( x1, y1, x2, y2 );</code></li>
		</ul>
	</li>

	<li>z-indexes:
		<ul>
			<li>#map:</li>

			<li>#mapbox:</li>

			<li>#overlay:</li>

			<li>individual cells:</li>
		</ul>
	</li>
</ul>

<h5>Server side</h5>

<ul>
	<li><code>Game game</code>
		<ul>
			<li><code>TtdGrid land</code> – auto-expanding grid of cells.
				<ul>
					<li>Currently organized to tiles with 10×10 cells – for optimization.</li>

					<li><code>Cell get( x, y )</code></li>

					<li><code>init()</code>, <code>run()</code>,
					<code>pause()</code>, <code>stop()</code></li>

					<li><code>persist()</code> – persists the game (to a DB?)</li>
				</ul>
			</li>

			<li><code>TtdData data</code> – holds all game data other than
			the land.</li>

			<li><code>GameTickerThread tickerThread</code> – runs a ticker in regular
			interval (1 s?).
				<ul>
					<li><code>GameTicker ticker</code> – modifies the world:
						<ul>
							<li>Waiting transportables in stations</li>

							<li>Towns growth</li>

							<li>Industry production adjustments</li>

							<li>Failures, disasters…</li>

							<li>Subsidies</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul>
	</li>

	<li>TtdDataJsonServlet – provides data to the client.
		<ul>
			<li>request: area info
			(<code>x1</code>,<code>y1</code>,<code>x2</code>,<code>y2</code>),
			<code>changedSince</code> [timestamp]</li>

			<li>JSON response: all information about the given area which changed
			since <code>changedSince</code>
				<ul>
					<li>cells</li>

					<li>stations</li>

					<li>…</li>
				</ul>
			</li>
		</ul>
	</li>
</ul>

<h4>OpenTTD Save/Load</h4>

<p><a href="http://svn.openttd.org/trunk/">http://svn.openttd.org/trunk/</a></p>

<p><code>src/saveload/map_sl.cpp</code></p>

<p><code>src/saveload/saveload.cpp</code></p>

<pre
class="xbrush: cpp"><code>/**
 * Save/Load an array.
 * @param array The array being manipulated
 * @param length The length of the array in elements
 * @param conv VarType type of the atomic array (int, byte, uint64, etc.)
 */
void SlArray(void *array, size_t length, VarType conv){ ... }</code></pre>

<p><code>src/map.cpp</code></p>

<pre
class="cpp"><code>uint _map_log_x;     ///&lt; 2^_map_log_x == _map_size_x
uint _map_log_y;     ///&lt; 2^_map_log_y == _map_size_y
uint _map_size_x;    ///&lt; Size of the map along the X
uint _map_size_y;    ///&lt; Size of the map along the Y
uint _map_size;      ///&lt; The number of tiles on the map
uint _map_tile_mask; ///&lt; _map_size - 1 (to mask the mapsize)

Tile *_m = NULL;          ///&lt; Tiles of the map
TileExtended *_me = NULL; ///&lt; Extended Tiles of the map</code></pre>

<p><code>src/map_type.h</code></p>

<pre
class="cpp"><code>/**
 * Data that is stored per tile. Also used TileExtended for this.
 * Look at docs/landscape.html for the exact meaning of the members.
 */
struct Tile {
        byte   type_height; ///&lt; The type (bits 4..7) and height of the northern corner
        byte   m1;          ///&lt; Primarily used for ownership information
        uint16 m2;          ///&lt; Primarily used for indices to towns, industries and stations
        byte   m3;          ///&lt; General purpose
        byte   m4;          ///&lt; General purpose
        byte   m5;          ///&lt; General purpose
        byte   m6;          ///&lt; Primarily used for bridges and rainforest/desert
};</code></pre>

<p><a
href="http://svn.openttd.org/trunk/docs/landscape.html">http://svn.openttd.org/…ndscape.html</a><br
/>
<a
href="http://209.85.135.132/search?q=cache:rgpOtgW-8moJ:svn.openttd.org/branches/0.6/docs/landscape.html+openttd+landscape.html&amp;cd=1&amp;hl=cs&amp;ct=clnk">http://209.85.135.132/search?…</a><br
/>
<a
href="http://209.85.135.132/search?q=cache:LyYGjBMLrogJ:svn.openttd.org/branches/custombridgeheads/docs/landscape_grid.html+site:svn.openttd.org&amp;cd=2&amp;hl=cs&amp;ct=clnk">http://209.85.135.132/search?…</a></p>

<p><a href="/samostatne/ttd/openttd-docs/landscape.html">OpenTTD's docs:
landscape</a> <a
href="/samostatne/ttd/openttd-docs/landscape_externals.html">OpenTTD's docs:
landscape_exter­nals</a> <a
href="/samostatne/ttd/openttd-docs/landscape_grid.html">OpenTTD's docs:
landscape_grid</a></p>

<p><a href="SaveTransformer.rar">OpenTTD save file transformer</a></p>

<h4>TODOs</h4>

<ul>
	<li>Construction toolbars</li>

	<li>Track and plan editation</li>

	<li>Building functions
		<ul>
			<li>First, road construction</li>
		</ul>
	</li>

	<li>AJAX push</li>

	<li>Complete basic subset of tables to make the game run</li>

	<li>Data model in Java</li>

	<li>Vehicle path movement animation
		<ul>
			<li>Will follow the „track“</li>

			<li>Track consists of arcs – parts of the track with the same direction.</li>

			<li>Each direction change is a waypoint of the animation</li>

			<li>Y axis movement slower than X</li>
		</ul>
	</li>

	<li>Get pictures from the OpenTTD project</li>

	<li>City growth algorithm</li>
</ul>

<h4>Links</h4>

<p><a
href="http://www.simugraph.com/simutrans-web/en/history/index.html">Simutrans
history</a></p>

<p><a href="http://www.tycoonez.com/">Tycoonez</a></p>

<p><a href="http://george.zernebok.net/">Geogre Zernebok</a> (Very interesting
page :)</p>

<p><a href="http://www.tt-forums.net/viewtopic.php?f=33&amp;t=45809">OpenTTD
forums</a> – link to my request for OpenTTD map export</p>

<h4>A bit of realism</h4>

<p>But of course, for one man, this is work for years.</p>

<p>For now, it will just be my humble dream :)</p>
</div>

	<hr />


    <!-- Facebook comments -->
        <div class="fb-comments" data-href="https://www.zizka.ch/pages/programovani/web_javascript_ajax_canvas/webttd.html" data-width="800" data-numposts="5"></div>

    </div>
    <div id="push"></div>

    <div id="pocitadla" class="" style="position: relative; top: -64px; left: 4xp;">
        <!--
        <div class="pocitadlo" id="navrcholu">
            <script src="http://c1.navrcholu.cz/code?site=116753;t=lb14" type="text/javascript"></script><noscript><div><a target="_blank" href="http://navrcholu.cz/"><img src="http://c1.navrcholu.cz/hit?site=116753;t=lb14;ref=;jss=0" width="14" height="14" alt="Statistiky NaVrcholu.cz" style="border:none" /></a></div></noscript>
        </div><!- - Driv: code?site=79008;t=lb14" -->
        <div class="pocitadlo" id="toplist">
            <a target="_blank" href="https://toplist.cz/stat/117144"><script language="JavaScript" type="text/javascript">
                document.write('<img src="https://toplist.cz/count.asp?id=117144&amp;start=806&amp;logo=2&amp;http='
                        +escape(document.referrer)+'&amp;wi='+escape(window.screen.width)+'&he='+escape(window.screen.height)
                        +'&amp;cd='+escape(window.screen.colorDepth)+'" width="36" height="14" border="0" alt="TOPlist statistiky" />');
            </script><noscript><img src="https://toplist.cz/count.asp?id=117144&amp;start=1&amp;logo=2" border="0" alt="TOPlist statistiky" width="36" height="14"/></noscript></a>
        </div>
        <!-- ClustrMaps.com -->
        <div class="pocitadlo" id="clustrmaps">
            <a href="https://www4.clustrmaps.com/user/64952149"><img src="https://www4.clustrmaps.com/stats/maps-no_clusters/ondra.zizka.cz--thumb.jpg" alt="0" border="0" width="180" height="117" /></a>
        </div>
    </div>

</div>

<div id="footer">
    <div class="container">
        <p class="muted credit">&copy; 2018 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.3.7</a> | Baked with <a href="http://jbake.org">JBake v2.7.0-SNAPSHOT</a></p>
    </div>
</div>

<script src="../../../js/jquery-1.11.1.min.js"></script>
<script src="../../../js/bootstrap.min.js"></script>
<script src="../../../js/prettify.js"></script>

<!-- Facebook comments -->
<div id="fb-root"></div>
<script>
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = 'https://connect.facebook.net/cs_CZ/sdk.js#xfbml=1&version=v3.0';
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-4584951-4"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-4584951-4');
</script>

<!-- Syntax highlighter -->
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shCore.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushBash.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushCpp.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushCSharp.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushCss.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushDelphi.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushDiff.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushGroovy.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushJScript.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushPhp.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushPlain.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushPython.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushRuby.js"></script>
<!--
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushScala.js"></script>
-->
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushSql.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushVb.js"></script>
<script type="text/javascript" src="/syntaxhighlighter3/scripts/shBrushXml.js"></script>
<link type="text/css" rel="stylesheet" href="/syntaxhighlighter3/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="/syntaxhighlighter3/styles/shThemeDefault.css"/>
<script type="text/javascript">
    SyntaxHighlighter.config.clipboardSwf = '/syntaxhighlighter3/scripts/clipboard.swf';
    SyntaxHighlighter.all();
</script>

</body>
</html>
